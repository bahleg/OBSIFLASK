{% extends 'base.html' %}

{% block content %}
<h1>Editor: {{path}}</h1>

<style>
  html,
  body {
    height: 100%;
    margin: 0;
  }

#container {
    display: flex;
    height: calc(100vh - 80px); /* –ø–æ–¥ —Ñ—É—Ç–µ—Ä/–∑–∞–≥–æ–ª–æ–≤–æ–∫ */
    width: 100%;
    border: 1px solid #ccc;
}

/* –†–µ–¥–∞–∫—Ç–æ—Ä —Å–ª–µ–≤–∞ */
#editor {
    font-family: monospace;
    height: 100%;
    width: 50%; /* —Å—Ç–∞—Ä—Ç–æ–≤–∞—è —à–∏—Ä–∏–Ω–∞ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ */
    min-width: 1024px; /* —á—Ç–æ–±—ã –Ω–µ —Å–∂–∏–º–∞–ª—Å—è —Å–ª–∏—à–∫–æ–º —Å–∏–ª—å–Ω–æ */
    border-right: 3px solid #888; /* —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å–Ω–∞—è –ª–∏–Ω–∏—è */
    padding: 10px;
    resize: horizontal; /* –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —Ä–∞—Å—Ç—è–≥–∏–≤–∞—Ç—å */
    overflow: auto;
}
.EasyMDEContainer {
    font-family: monospace;
    height: 100%;
    width: 50%; /* —Å—Ç–∞—Ä—Ç–æ–≤–∞—è —à–∏—Ä–∏–Ω–∞ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ */
    min-width: 640px; /* —á—Ç–æ–±—ã –Ω–µ —Å–∂–∏–º–∞–ª—Å—è —Å–ª–∏—à–∫–æ–º —Å–∏–ª—å–Ω–æ */
    border-right: 3px solid #888; /* —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å–Ω–∞—è –ª–∏–Ω–∏—è */
    padding: 10px;
    resize: horizontal; /* –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —Ä–∞—Å—Ç—è–≥–∏–≤–∞—Ç—å */
    overflow: auto;
}

/* –ü—Ä–µ–≤—å—é —Å–ø—Ä–∞–≤–∞ */
#preview {
    flex-grow: 1;
    padding: 10px;
    overflow: auto;
}


  #flo-toggle-btn {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1000;
    background: #333;
    color: white;
    padding: 8px 12px;
    border-radius: 4px;
    cursor: pointer;
    text-decoration: none;
    /* —É–±–∏—Ä–∞–µ–º –ø–æ–¥—á—ë—Ä–∫–∏–≤–∞–Ω–∏–µ */
    display: inline-block;
    /* —á—Ç–æ–±—ã padding —Ä–∞–±–æ—Ç–∞–ª –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ */
  }

  #flo-toggle-btn:hover {
    background: #555;
    /* —ç—Ñ—Ñ–µ–∫—Ç –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
  }




  #flo-save-btn {
    position: fixed;
    top: 20px;
    right: 70px;
    z-index: 1000;
    background: #333;
    color: white;
    padding: 8px 12px;
    border-radius: 4px;
    cursor: pointer;
    text-decoration: none;
    /* —É–±–∏—Ä–∞–µ–º –ø–æ–¥—á—ë—Ä–∫–∏–≤–∞–Ω–∏–µ */
    display: inline-block;
    /* —á—Ç–æ–±—ã padding —Ä–∞–±–æ—Ç–∞–ª –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ */
  }

  #flo-save-btn:hover {
    background: #555;
    /* —ç—Ñ—Ñ–µ–∫—Ç –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
  }
</style>


<a id="flo-toggle-btn" href="{{url_for('renderer', vault = vault, subpath = path)}}"><i class="bi bi-eye"></i></a>
<a id="flo-save-btn" href="{{url_for('renderer', vault = vault, subpath = path)}}"><i class="bi bi-floppy"></i></a>
<style>
@media (max-width: 767.98px) {
  #flo-toggle-btn,
  #flo-save-btn {
    padding: 4px 6px;
    font-size: 14px;
    top: auto;
    bottom: 15px;  /* –ø–µ—Ä–µ–Ω–æ—Å–∏–º –≤–Ω–∏–∑ */
    right: 15px;
  }

  #flo-save-btn {
    right: 60px; /* —á—É—Ç—å –ª–µ–≤–µ–µ toggle */
  }
}
</style>

<div id="container">
  <textarea id="editor" class="form-control">{{markdown_text}}</textarea>
  <div id="preview" class="d-none d-lg-block">{{markdown_html|safe}}</div>
</div>
<style>

@media (max-width: 991.98px) {
  #editor {
    width: 100% !important;
    min-width: auto;
    border-right: none;
  }
}
</style>




<script>
  const editor = document.getElementById('editor');
  const saveBtn = document.getElementById('flo-save-btn');
  const alertPlaceholder = document.getElementById('page-content-wrapper');

  let saveTimeout = null;
  const SAVE_DELAY = 10000;
  let isDirty = false;

  // —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –∞–ª–µ—Ä—Ç–∞
  function showAlert(message, type = 'success') {
    const wrapper = document.createElement('div');
    wrapper.innerHTML = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>`;
    alertPlaceholder.append(wrapper);

    // –∞–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
    setTimeout(() => {
      const alertNode = bootstrap.Alert.getOrCreateInstance(wrapper.querySelector('.alert'));
      alertNode.close();
    }, 5000);
  }


  // —Ñ—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
  function saveDocument() {
    const content = editor.value;
    fetch('{{url_for("save_file", vault=vault, subpath=path)}}', {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ content })
    })
      .then(res => {
        if (res.ok) {
          isDirty = false;
          showAlert('Saved successfully!', 'success');
          // 2Ô∏è‚É£ –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–π Markdown —Å —Å–µ—Ä–≤–µ—Ä–∞
          return fetch('{{ url_for("preview", vault=vault, subpath=path) }}');
        }
      })
      .then(res => res.json())
      .then(data => {
        if (data.content !== undefined) {
          preview.innerHTML = data.content;
        } else {
          showAlert('Error: server did not return content', 'danger');
        }
      })
      .catch(err => {
        console.error(err);
        showAlert('Error saving file', 'danger');
      });
  }

  // –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —á–µ—Ä–µ–∑ N —Å–µ–∫—É–Ω–¥ –ø–æ—Å–ª–µ –≤–≤–æ–¥–∞
  editor.addEventListener('input', () => {
    isDirty = true;
    if (saveTimeout) clearTimeout(saveTimeout);
    saveTimeout = setTimeout(saveDocument, SAVE_DELAY);
  });

  // —Ä—É—á–Ω–∞—è –∫–Ω–æ–ø–∫–∞ üíæ
  saveBtn.addEventListener('click', (e) => {
    e.preventDefault(); // —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–ª–∞—Å—å —Å—Ç—Ä–∞–Ω–∏—Ü–∞
    saveDocument();
  });

  // –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø—Ä–∏ —É—Ö–æ–¥–µ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  window.addEventListener('beforeunload', (e) => {
    if (isDirty) {

      e.preventDefault();
      e.returnValue = '';
    }
  });
</script>

{% endblock %}