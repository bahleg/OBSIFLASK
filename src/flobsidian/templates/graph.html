{% extends 'base.html' %}

{% block content %}
<h1>Global graph</h1>
<a id="flo-refresh-btn" href="{{url_for('graph', vault = vault)}}?refresh=1"><i class="bi bi-arrow-clockwise"></i></a>
<button id="toggle-panel"><i class="bi bi-gear-wide-connected"></i></button>

<style>
  #control-panel {
    position: fixed;
    top: 60px;
    right: 0;
    width: 250px;
    height: auto;
    background: var(--bs-body-bg);
    color: var(--bs-body-color);
    border-left: 1px solid var(--bs-border-color, #ccc);
    padding: 15px;
    z-index: 2000;
    transition: transform 0.3s ease;

  }

  #control-panel.hidden {
    transform: translateX(200%);
  }



  #control-panel label {
    display: block;
    margin-top: 10px;
    font-size: 0.9rem;
  }
</style>
<div id="control-panel" style="
    position: fixed;
    top: 60px;
    right: 20px;
    width: 240px;
    padding: 10px;
    background: var(--bs-body-bg);
    color: var(--bs-body-color);
    border: 1px solid #ccc;
    border-radius: 5px;
    z-index: 1000;
    font-size: 14px;
">
  <h5>Graph Settings</h5>

  <label>Node spacing: <span id="repulsion-val">4500</span></label>
  <input type="range" id="repulsion" min="100" max="10000" step="100" value="4500"><br><br>

  <label>Edge length: <span id="spring-val">100</span></label>
  <input type="range" id="spring" min="10" max="500" step="10" value="100"><br><br>

  <label>Edge stiffness: <span id="stiffness-val">0.45</span></label>
  <input type="range" id="stiffness" min="0.1" max="1.0" step="0.01" value="0.45"><br><br>

  <label>Graph compression: <span id="gravity-val">1</span></label>
  <input type="range" id="gravity" min="0" max="5" step="0.1" value="1"><br><br>

  <button id="apply-forces" class="btn btn-sm btn-primary">Apply</button>
</div>


<style>
  body {
    margin: 0;
    padding: 0;
  }

  #cy {
    width: 100vw;
    height: 100vh;
    display: block;
  }


  #flo-refresh-btn {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1000;
    background: #333;
    color: white;
    padding: 8px 12px;
    border-radius: 4px;
    cursor: pointer;
    text-decoration: none;
    /* убираем подчёркивание */
    display: inline-block;
    /* чтобы padding работал корректно */

  }

  #toggle-panel:hover {
    background: #555;
    /* эффект при наведении */
    border: none;
  }


  #toggle-panel {
    position: fixed;
    top: 20px;
    right: 70px;
    z-index: 1000;
    background: #333;
    color: white;
    padding: 8px 12px;
    border-radius: 4px;
    cursor: pointer;
    text-decoration: none;
    /* убираем подчёркивание */
    display: inline-block;
    /* чтобы padding работал корректно */
    border: none;
  }

  #flo-refresh-btn:hover {
    background: #555;
    /* эффект при наведении */
  }
</style>
<script src="https://unpkg.com/cytoscape@3.30.4/dist/cytoscape.min.js"></script>
<script src="https://unpkg.com/layout-base/layout-base.js"></script>
<script src="https://unpkg.com/cose-base/cose-base.js"></script>
<script src="https://unpkg.com/cytoscape-fcose/cytoscape-fcose.js"></script>

<div id="cy"></div>
<script>

  const root = document.documentElement;

  // Основной фон страницы
  const bgColor = getComputedStyle(root).getPropertyValue('--bs-body-bg').trim();
  // Цвет текста
  const textColor = getComputedStyle(root).getPropertyValue('--bs-body-color').trim();

  const edgeColor = getComputedStyle(document.documentElement).getPropertyValue('--bs-secondary').trim();

  // Цвет кнопок/primary (для нод)
  const primaryColor = getComputedStyle(root).getPropertyValue('--bs-primary').trim();


  const graphData = {{ graph_data | tojson }};

  const elements = [];

  // Узлы
  graphData.node_labels.forEach((label, i) => {
    elements.push({
      data: {
        id: "n" + i,
        label: label,
        size: graphData.node_sizes[i],
        href: graphData.href[i]
      }
    });
  });

  // Рёбра
  graphData.forward_edges.forEach(([src, dst]) => {
    elements.push({
      data: {
        id: "e" + src + "_" + dst,
        source: "n" + src,
        target: "n" + dst
      }
    });
  });

  const cy = cytoscape({
    container: document.getElementById('cy'),
    elements: elements,
    style: [
      {
        selector: 'node',
        style: {
          'content': '',                  // нет текста
          'text-valign': 'center',
          'color': textColor,           // текст под тему
          'background-color': primaryColor,  // ноды под тему
          'width': 'mapData(size, 1, 100, 20, 100)',
          'height': 'mapData(size, 1, 100, 20, 100)',
          'font-size': '15px',
          'cursor': 'pointer',
          'text-margin-y': -20        // отступ наверх

        }
      },



      {
        selector: 'edge',
        style: {
          'width': 2,
          'line-color': edgeColor,
          'target-arrow-color': edgeColor,
          'target-arrow-shape': 'triangle'
        }
      }
    ],
    layout: { name: 'fcose', animate: true },

    // Настройки рендера
    renderer: {
      name: 'canvas',
      webgl: {{ use_webgl }},
  showFps: { { debug_graph } },
  webglDebug: { { debug_graph } },
    }
  });


  // Клик по ноде → переход по ссылке
  cy.on('tap', 'node', function (evt) {
    const url = evt.target.data('href');
    if (url) {
      window.open(url, "_blank");
    }
  });

  cy.on('mouseover', 'node', function (evt) {
    var node = evt.target;
    node.style({
      'content': node.data('label'),
      'text-valign': 'top',
      'text-halign': 'center',
      'text-margin-y': -20,
      'z-index': 1000
    });
  });

  cy.on('mouseout', 'node', function (evt) {
    var node = evt.target;
    node.style({
      'content': '',
      'z-index': 0

    });
  });

</script>


<script>
  function getQueryParam(name) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(name);
  }

  // --- обработка параметра ---
  const myParam = getQueryParam("refresh");
  if (myParam) {

    // --- убираем параметр из URL ---
    const url = new URL(window.location);
    url.searchParams.delete("refresh"); // удаляем
    window.history.replaceState({}, document.title, url);
  }


</script>

<script>
  const panel = document.getElementById("control-panel");
  const toggleBtn = document.getElementById("toggle-panel");

  toggleBtn.addEventListener("click", () => {
    panel.classList.toggle("hidden");
  });

  function applyForces() {
    const nodeRepulsion = parseFloat(document.getElementById('repulsion').value);
    const idealEdgeLength = parseFloat(document.getElementById('spring').value);
    const springStiffness = parseFloat(document.getElementById('stiffness').value);
    const gravity = parseFloat(document.getElementById('gravity').value);

    // Update labels
    document.getElementById('repulsion-val').innerText = nodeRepulsion;
    document.getElementById('spring-val').innerText = idealEdgeLength;
    document.getElementById('stiffness-val').innerText = springStiffness;
    document.getElementById('gravity-val').innerText = gravity;

    const layout = cy.layout({
      name: 'fcose',
      animate: true,
      nodeRepulsion: nodeRepulsion,
      idealEdgeLength: idealEdgeLength,
      springConstant: springStiffness,
      gravity: gravity,
      numIter: 2500
    });

    layout.run();
  }

  // Button click event
  document.getElementById('apply-forces').addEventListener('click', applyForces);


</script>
{% endblock %}