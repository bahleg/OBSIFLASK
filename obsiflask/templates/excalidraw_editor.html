{% extends 'base.html' %}

{% block content %}
<h1>Excalidraw: <a href="{{url_for('get_folder', vault=vault, subpath=curdir)}}">{{curdir}}</a>/{{curfile.split('/')[-1]}}</h1>
<div id="save-status">(saved)</div>

<link rel="stylesheet" href="{{ url_for('static', filename='excalidraw/excalidraw.css') }}">
<script>
  window.EXCALIDRAW_ASSET_PATH = "{{ url_for('static', filename='excalidraw/assets/') }}";
</script>
<script type="importmap">
  {
    "imports": {
      "react": "https://esm.sh/react@18.2.0",
      "react-dom": "https://esm.sh/react-dom@18.2.0",
      "react/jsx-runtime": "https://esm.sh/react@18.2.0/jsx-runtime"
    }
  }
  </script>
<style>
  html,
  body {
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100%;
    overflow: hidden;
  }

  #app {
    width: 100%;
    height: 100%;
    max-width: 100vw;
    max-height: 100vh;
  }



     #flo-download-btn {
    position: fixed;
    top: 20px;
    right: 120px;
    z-index: 1000;
    background: #333;
    color: white;
    padding: 8px 12px;
    border-radius: 4px;
    cursor: pointer;
    text-decoration: none;
    /* —É–±–∏—Ä–∞–µ–º –ø–æ–¥—á—ë—Ä–∫–∏–≤–∞–Ω–∏–µ */
    display: inline-block;
    /* —á—Ç–æ–±—ã padding —Ä–∞–±–æ—Ç–∞–ª –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ */
  }

  #flo-download-btn:hover {
    background: #555;
    /* —ç—Ñ—Ñ–µ–∫—Ç –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
  }





  #flo-save-btn {
    position: fixed;
    top: 20px;
    right: 70px;
    z-index: 1000;
    background: #333;
    color: white;
    padding: 8px 12px;
    border-radius: 4px;
    cursor: pointer;
    text-decoration: none;
    /* —É–±–∏—Ä–∞–µ–º –ø–æ–¥—á—ë—Ä–∫–∏–≤–∞–Ω–∏–µ */
    display: inline-block;
    /* —á—Ç–æ–±—ã padding —Ä–∞–±–æ—Ç–∞–ª –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ */
  }

  #flo-save-btn:hover {
    background: #555;
    /* —ç—Ñ—Ñ–µ–∫—Ç –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
  }

    #flo-toggle-btn {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1000;
    background: #333;
    color: white;
    padding: 8px 12px;
    border-radius: 4px;
    cursor: pointer;
    text-decoration: none;
    /* —É–±–∏—Ä–∞–µ–º –ø–æ–¥—á—ë—Ä–∫–∏–≤–∞–Ω–∏–µ */
    display: inline-block;
    /* —á—Ç–æ–±—ã padding —Ä–∞–±–æ—Ç–∞–ª –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ */
  }

  #flo-toggle-btn:hover {
    background: #555;
    /* —ç—Ñ—Ñ–µ–∫—Ç –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
  }

</style>

<a id="flo-download-btn" href="{{url_for('get_file', vault = vault, subpath = path)}}"><i class="bi bi-download"></i></a>
<a id="flo-toggle-btn" href="{{url_for('editor', vault = vault, subpath = path)}}"><i class="bi bi-eye"></i></a>
<a id="flo-save-btn" href=""><i class="bi bi-floppy"></i></a>


<div id="app"></div>
<div id="save-status">(saved)</div>

<script type="module">
  import React from "https://esm.sh/react@18.2.0";
  import ReactDOM from "https://esm.sh/react-dom@18.2.0/client";
  import { Excalidraw } from "https://esm.sh/@excalidraw/excalidraw@0.18.0?deps=react@18.2.0,react-dom@18.2.0";

  const initialData = {{ excalidraw_json| safe }};
  const SAVE_DELAY = 5000; // 10 —Å–µ–∫—É–Ω–¥
  let isDirty = false;
  let saveTimeout = null;
  let currentData = initialData;

  function showSaveStatus(text) {
    document.getElementById('save-status').innerText = text;
  }

  // some problems with saving excalidraw raw data. possible version mismatch
  function sanitizeExcalidrawData(data) {
    return {
      ...data,
      appState: {
        ...data.appState,
        collaborators: Array.isArray(data.appState?.collaborators)
          ? data.appState.collaborators
          : [],
      },
      elements: data.elements || [],
    };
  }



  function saveDocument() {

    fetch('{{ url_for("save_file", vault=vault, subpath=path) }}', {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ content: JSON.stringify(sanitizeExcalidrawData(currentData)) })
    })
      .then(res => {
        if (res.ok) {
          isDirty = false;
          showSaveStatus('(saved)');
        } else {
          showSaveStatus('(error saving)');
        }
      })
      .catch(err => {
        console.error(err);
        showSaveStatus('(error saving)');
      });
  }

  function App() {
    let initialized = false;
    return React.createElement("div", { style: { width: "100%", height: "100%" } },
      React.createElement(Excalidraw, {
        initialData: initialData,
        style: { width: "100%", height: "100%" },
        onChange: (elements, appState) => {

          if (!initialized) {
            initialized = true;
            return; // –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –ø–µ—Ä–≤—ã–π –≤—ã–∑–æ–≤
          }

          currentData = { type: "excalidraw", version: 2, source: "flask", elements, appState };
          isDirty = true;
          showSaveStatus('(unsaved)');

          if (saveTimeout) clearTimeout(saveTimeout);
          saveTimeout = setTimeout(saveDocument, SAVE_DELAY);
        }



      })
    );
  }

  const root = ReactDOM.createRoot(document.getElementById("app"));
  root.render(React.createElement(App));

  // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø—Ä–∏ —É—Ö–æ–¥–µ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  window.addEventListener("beforeunload", (e) => {
    if (isDirty) {
      e.preventDefault();
      e.returnValue = '';
    }
  });

  const saveBtn = document.getElementById('flo-save-btn');

  // —Ä—É—á–Ω–∞—è –∫–Ω–æ–ø–∫–∞ üíæ
  saveBtn.addEventListener('click', (e) => {
    e.preventDefault(); // —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–ª–∞—Å—å —Å—Ç—Ä–∞–Ω–∏—Ü–∞
    saveDocument();
  });
</script>


{% endblock %}