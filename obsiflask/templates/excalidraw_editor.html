{% extends 'base.html' %}

{% block content %}
<h1>Excalidraw: <code><a
    href="{{url_for('get_folder', vault=vault, subpath=curdir)}}">{{curdir}}</a>/{{curfile.split('/')[-1]}}</code></h1>
<div id="save-status">(saved)</div>

<link rel="stylesheet" href="{{ url_for('static', filename='excalidraw/excalidraw.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='excalidraw_editor.css') }}">
<script>
  window.EXCALIDRAW_ASSET_PATH = "{{ url_for('static', filename='excalidraw/assets/') }}";
</script>
<script type="importmap">
  {
    "imports": {
      "react": "https://esm.sh/react@18.2.0",
      "react-dom": "https://esm.sh/react-dom@18.2.0",
      "react/jsx-runtime": "https://esm.sh/react@18.2.0/jsx-runtime"
    }
  }
  </script>

<div class="flo-btn-group">
  <a id="flo-save-btn" class="flo-btn" href=""><i class="bi bi-floppy"></i></a>
  <a id="flo-toggle-btn" class="flo-btn" href="{{url_for('editor', vault = vault, subpath = path)}}"><i
      class="bi bi-pencil"></i></a>

  <a id="flo-download-btn" class="flo-btn" href="{{url_for('get_file', vault = vault, subpath = path)}}"><i
      class="bi bi-download"></i></a>
</div>

<div id="app"></div>
<div id="save-status">(saved)</div>

<script type="module">
  import React from "https://esm.sh/react@18.2.0";
  import ReactDOM from "https://esm.sh/react-dom@18.2.0/client";
  import { Excalidraw } from "https://esm.sh/@excalidraw/excalidraw@0.18.0?deps=react@18.2.0,react-dom@18.2.0";

  const initialData = {{ excalidraw_json| safe }};
  const SAVE_DELAY = {{ injected_vars["config"].vaults[vault].autosave_time * 1000 }};

  let isDirty = false;
  let saveTimeout = null;
  let currentData = initialData;

  function showSaveStatus(text) {
    document.getElementById('save-status').innerText = text;
  }

  // some problems with saving excalidraw raw data. possible version mismatch
  function sanitizeExcalidrawData(data) {
    return {
      ...data,
      appState: {
        ...data.appState,
        collaborators: Array.isArray(data.appState?.collaborators)
          ? data.appState.collaborators
          : [],
      },
      elements: data.elements || [],
    };
  }



  function saveDocument() {

    fetch('{{ url_for("excalidraw", vault=vault, subpath=path) }}', {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ content: JSON.stringify(sanitizeExcalidrawData(currentData)) })
    })
      .then(res => {
        if (res.ok) {
          isDirty = false;
          showSaveStatus('(saved)');
        } else {
          showSaveStatus('(error saving)');
        }
      })
      .catch(err => {
        console.error(err);
        showSaveStatus('(error saving)');
      });
  }

  function App() {
    let initialized = false;
    return React.createElement("div", { style: { width: "100%", height: "100%" } },
      React.createElement(Excalidraw, {
        initialData: initialData,
        style: { width: "100%", height: "100%" },
        onChange: (elements, appState) => {

          if (!initialized) {
            initialized = true;
            return; // first call ignoring
          }

          currentData = { type: "excalidraw", version: 2, source: "flask", elements, appState };
          isDirty = true;
          showSaveStatus('(unsaved)');

          if (saveTimeout) clearTimeout(saveTimeout);
          saveTimeout = setTimeout(saveDocument, SAVE_DELAY);
        }



      })
    );
  }

  const root = ReactDOM.createRoot(document.getElementById("app"));
  root.render(React.createElement(App));

  //  warning when leaving
  window.addEventListener("beforeunload", (e) => {
    if (isDirty) {
      e.preventDefault();
      e.returnValue = '';
    }
  });

  const saveBtn = document.getElementById('flo-save-btn');

  // button ðŸ’¾
  saveBtn.addEventListener('click', (e) => {
    e.preventDefault(); // prevent from reload
    saveDocument();
  });

  document.addEventListener("keydown", function (e) {
    if (e.ctrlKey && e.key === "s") {
        e.preventDefault();
        saveDocument();     
    }
});



</script>



{% endblock %}