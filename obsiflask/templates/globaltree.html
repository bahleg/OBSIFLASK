{% macro render_tree(vault, page_editor, current_path, current_dir) %}
<link href="https://cdn.jsdelivr.net/npm/jquery.fancytree/dist/skin-lion/ui.fancytree.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery.fancytree/dist/jquery.fancytree-all-deps.min.js"></script>

<div id="tree"></div>

<script>
    let expand_more = false;
    let currentPath = "{{ current_path }}";
    let currentDir = "{{ current_dir }}";
    if (!currentPath) {
        currentPath = currentDir;
        expand_more = true;
    }
    let navtree = $("#tree").fancytree({
        source: { url: "{{url_for('tree', vault=vault)}}/?edit={{page_editor}}" },
        lazyLoad: function (event, data) {
            let node = data.node;

            let url = "{{ url_for('tree', vault=vault) }}/" + encodeURIComponent(node.key) + "?edit={{page_editor}}";
            console.log(['lazy', url])
            data.result = { url: url };
        },
        activate: function (event, data) {
            let node = data.node;
            if (node.data.url) {
                window.location.href = node.data.url;
            }
        },
        init: function (event, data) {
            if (currentPath) {
                console.log("Init tree, currentPath=", currentPath);
                let tree = data.tree;
                let parts = currentPath.split("/");

                // Родительский путь для expand
                let expandParts = []
                if (expand_more) {
                    expandParts = parts;
                }
                else {
                    expandParts = parts.slice(0, -1);
                }

                let targetKey = currentPath;
                console.log('parts', [expandParts])
                expandPath(tree, expandParts, function () {

                    let node = tree.getNodeByKey(targetKey);
                    if (node) {
                        node.setSelected(true);
                        node.setFocus(true);
                        node.makeVisible();

                    } else {
                        console.log("Node not found:", [targetKey]);
                        tree.visit(function (node) {
                            console.log("KEY:", [node.key], "TITLE:", node.title, "FOLDER:", node.folder, "LAZY:", node.lazy);
                        });
                    }
                })




            }
        }


    });

    function expandPath(tree, parts, callback) {
        if (!parts.length) {
            if (callback) callback();
            return;
        }
        let current = "";
        let queue = [...parts]; // копия массива

        function step() {
            if (!queue.length) {
                if (callback) callback();
                return;
            }
            current = current ? current + "/" + queue.shift() : queue.shift();
            let node = tree.getNodeByKey(current);
            console.log('subexpanding', current)
            if (node) {
                node.setExpanded(true).done(step);
            }
        }
        step();
    }

</script>

{% endmacro %}

{{render_tree(vault, True)}}